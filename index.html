<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Jukola 2026 – valitse karttataso</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; height: 100%; }

    #moreModalBody a {
      color: #1a73e8;
      text-decoration: none;
      font-weight: 600;
    }
    #moreModalBody a:hover {
      text-decoration: underline;
    }
    #moreModalBody a:visited {
      color: #1558b0;
    }

    /* Nosta mittakaavajanaa ylemmäs ettei se jää copyright-tekstien alle */
    .leaflet-bottom.leaflet-left .leaflet-control-scale {
      margin-bottom: 35px !important;
    }


    #uiContainer {
      position: absolute;
      top: 10px;
      left: 60px;
      z-index: 1000;
      display: flex;
      gap: 10px;
      flex-wrap: nowrap;
      align-items: flex-start;
    }

    .uiBox {
      background: white;
      padding: 6px 8px;
      font-family: sans-serif;
      font-size: 16px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      line-height: 1.4;
      box-sizing: border-box;
      border-radius: 8px;
      max-width: 240px;
    }

    /* Pohjakartta-laatikko leveämmäksi */
    #layerToggle.uiBox {
      max-width: 160px;
      min-width: 160px;
    }

    .uiHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 6px;
      gap: 10px;
    }

    .collapseBtn {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      padding: 0 2px;
    }

    .uiBox.collapsed .uiContent { display: none; }

    #overlayOnOffBtn {
      display: inline-block;
      margin-bottom: 8px;
      padding: 4px 8px;
      font-size: 14px;
      border: 1px solid #888;
      border-radius: 6px;
      background: #f7f7f7;
      cursor: pointer;
    }
    #overlayOnOffBtn.off { background: #eee; color: #666; }

    #overlaySelect {
      width: 100%;
      font-size: 14px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #888;
      background: #fff;
    }
    #overlaySelect:disabled {
      background: #f1f1f1;
      color: #777;
    }

    /* (voit jättää tämän, vaikka linkit siirtyy modaliin) */
    .smallLink {
      display: inline-block;
      margin-left: 6px;
      margin-top: 6px;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #888;
      background: #f7f7f7;
      color: #000;
      text-decoration: none;
      cursor: pointer;
    }
    .smallLink:hover { background: #e6e6e6; }

    /* =========================
       ☰ Lisää -valikko (modal)
       ========================= */
    /* Leaflet-controlina näkyvä ☰-nappi */
    .leaflet-control-more.leaflet-bar {
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }

    .leaflet-control-more button {
      width: 33px;
      height: 33px;
      border: none;
      background: #fff;
      cursor: pointer;
      font-size: 22px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }

    /* pieni väli zoom-nappien ja ☰-napin väliin */
    .leaflet-top.leaflet-left .leaflet-control-more {
      margin-top: 6px;
    }

    @media (max-width: 520px) {
      .leaflet-control-more button { width: 38px; height: 38px; font-size: 21px; }
    }


    #moreModal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 12px;
      box-sizing: border-box;
    }
    #moreModal.open { display: flex; }

    #moreModalCard {
      background: #fff;
      width: min(92vw, 420px);
      max-height: 80vh;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      font-family: sans-serif;
    }

    #moreModalHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      font-weight: bold;
      border-bottom: 1px solid #ddd;
    }

    #moreCloseBtn {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      padding: 4px 6px;
      border-radius: 8px;
    }
    #moreCloseBtn:hover { background: #f1f1f1; }

    #moreModalBody {
      padding: 12px;
      overflow: auto;
      font-size: 14px;
      line-height: 1.45;
    }

    #moreModalBody a {
      color: #0b57d0;
      text-decoration: underline;
    }

    @media (max-width: 520px) {
      #uiContainer { left: 55px; right: 10px; }
      .uiBox {
        font-size: 14px;
        padding: 6px;
        max-width: calc(50vw - 12px);
      }
      .uiHeader { font-size: 13px; }

      #moreBtn { width: 38px; height: 38px; font-size: 21px; }
      #moreModalCard { width: min(94vw, 520px); max-height: 85vh; }
    }
  </style>
</head>
<body>

  <div id="uiContainer">
    <div id="layerToggle" class="uiBox">
      <div class="uiHeader">
        <span>Pohjakartta</span>
        <button id="collapseBtn1" class="collapseBtn" type="button" title="Pienennä/laajenna">▲</button>
      </div>
      <div class="uiContent">
        <label><input type="radio" name="layer" value="satelliitti"> Satelliittikuva</label><br>
        <label><input type="radio" name="layer" value="orto"> Ilmakuva</label><br>
        <label><input type="radio" name="layer" value="maasto" checked> Maastokartta</label><br>
        <label><input type="radio" name="layer" value="mapant"> MapAnt</label><br>        
        <label><input type="radio" name="layer" value="rinnevarjoste"> Rinnevarjoste</label><br>
      </div>
    </div>

    <div id="overlayToggle" class="uiBox">
      <div class="uiHeader">
        <span>Kartta (overlay)</span>
        <button id="collapseBtn2" class="collapseBtn" type="button" title="Pienennä/laajenna">▲</button>
      </div>

      <div class="uiContent">
        <button id="overlayOnOffBtn" type="button" title="Näytä/piilota overlay">On/Off</button>

        <select id="overlaySelect" title="Valitse overlay-kartta">
          <option value="">(Ei overlayta)</option>
          <option value="esijukola">Esi-Jukola</option>
          <option value="efky1">Kymin lentokenttä</option>
          <option value="efky2">Kymin lentokenttä 2</option>
          <option value="pahavuori">Pahavuori</option>
          <option value="laukkakallio">Laukkakallio</option>
          <option value="tavastila">Tavastila</option>
          <option value="peippola">Peippola</option>
          <option value="kirkkovuoret">Kirkkovuoret</option>
          <option value="rapukallio">Rapukallio</option>
          <option value="kooste">Kooste vanhoista</option>
          <option value="saarijarvi">Saarijärvi, 1986</option>
          <option value="1986">Fin 5, 1986</option>
          <option value="1975">SM-viesti, 1975</option>
          <option value="rasteja">Kuvitteellisia rasteja</option>
        </select>

      </div>
    </div>
  </div>



  <!-- Modal / teksti-ikkuna -->
  <div id="moreModal" aria-hidden="true">
    <div id="moreModalCard" role="dialog" aria-modal="true" aria-labelledby="moreTitle">
      <div id="moreModalHeader">
        <span id="moreTitle">Lisätietoja</span>
        <button id="moreCloseBtn" type="button" title="Sulje">✕</button>
      </div>
      <div id="moreModalBody">
        Tällä sivulla voi tutustua Kotka Jukolan 2026 kilpailumaastoon.
        Harjoituskieltoalue on merkitty punaisella. 
        Valitse pohjakartta ja sen päälle erilaisia vanhoja karttoja. 
        Valitsemalla vanhan kartan on/off voit vertailla miten esim. avokalliot
        näkyvät vanhalla kartalla verrattuna ilmakuvaan.
        <br><br>

        <p style="margin:0 0 8px 0;"><b>Linkkejä</b></p>
        <p style="margin:0;">
          <a href="rastit.html" target="_blank" rel="noopener">Kuvitteelliset rastit uuteen välilehteen</a>
          <br><br>
          <a href="https://www.maanmittauslaitos.fi/sites/maanmittauslaitos.fi/files/attachments/2025/05/karttamerkkien_selite_2025_0.pdf" target="_blank" rel="noopener">Maastokartan karttamerkit</a>
          <br><br>
          <a href="https://3dkartta.fi/#60.57563,26.89900,3484m/topo-fi" target="_blank" rel="noopener">3dkartta.fi</a>                    
          <br><br>
          <a href="https://jukola.com/2026/harjoituskieltoalue-map/" target="_blank" rel="noopener">jukola.com</a>
          <br><br>
          <a href="https://www.google.com/maps/@60.5773589,26.897016,2980m/data=!3m1!1e3?entry=ttu" target="_blank" rel="noopener">maps.google.com</a>
          <br>Google Maps esittää tuoreet satelliittikuvat vuodelta 2025. Niistä näkyy missä on tehty uusimmat hakkuut.
          
        </p>
      </div>
    </div>
  </div>

  <div id="map"></div>
  <div id="nlsAttribution"></div>
  

<script>
  // =========================
  // ASETUKSET
  // =========================
  const MML_API_KEY = '060d0c90-a4de-483c-8bb3-4d69bcf5b56f';

  // *** LOGIIKKA: vain ORTO vaihtaa lähdettä zoomin perusteella:
  // *** z <= 15 => ORTO haetaan MML WMTS:stä, z >= 16 => ORTO haetaan lokaalisti (GitHub).
  const ORTO_SWITCH_ZOOM = 15; // raja, jonka alapuolella käytetään MML:ää

  const map = L.map('map', {
    center: [60.5750, 26.8939],
    zoom: 14,
    minZoom: 13,
    maxZoom: 18,
    fadeAnimation: false   // <- estää “pehmeän” ilmestymisin
  });

  // ☰ nappi Leaflet-controlina zoom-nappien alle (topleft)
  const MoreControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
      const wrapper = L.DomUtil.create('div', 'leaflet-control-more leaflet-bar');
      const btn = L.DomUtil.create('button', '', wrapper);
      btn.id = 'moreBtn';
      btn.type = 'button';
      btn.title = 'Lisää';
      btn.textContent = '☰';

      // ettei kartta zoomaa/draggaa napin käytöstä
      L.DomEvent.disableClickPropagation(wrapper);
      L.DomEvent.disableScrollPropagation(wrapper);

      return wrapper;
    }
  });
  map.addControl(new MoreControl());


  L.control.scale({
    position: 'bottomleft',
    metric: true,
    imperial: false,
    maxWidth: 140
  }).addTo(map);

  map.createPane('topLinePane');
  map.getPane('topLinePane').style.zIndex = 9999;

  const esriLayer = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { attribution: 'Karttakuva © Esri & contributors', maxZoom: 19, updateWhenIdle: true, reuseTiles: true, keepBuffer: 2 }
  ).addTo(map);

  const smoothTileOpts = {
    updateWhenIdle: true,
    updateWhenZooming: false,
    reuseTiles: true,
    keepBuffer: 3
  };
  
  const mapantLayer = L.tileLayer(
    'https://wmts.mapant.fi/wmts_EPSG3857.php?z={z}&x={x}&y={y}',
    {
      maxZoom: 19,
      opacity: 1.0,
      ...smoothTileOpts,
      attribution: '© MapAnt + © National Land Survey of Finland (NLS/MML) — https://www.mapant.fi/'
    }
  );
  



  function isOrtoLowZoom() { return map.getZoom() <= ORTO_SWITCH_ZOOM; }

  // =========================
  // MML WMTS ORTO (vain z <= 15)
  // =========================
  const mmlOrtoLow = L.tileLayer(
    `https://avoin-karttakuva.maanmittauslaitos.fi/avoin/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0` +
    `&LAYER=ortokuva&STYLE=default&TILEMATRIXSET=WGS84_Pseudo-Mercator` +
    `&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/jpeg&api-key=${encodeURIComponent(MML_API_KEY)}`,
    { minZoom: 0, maxZoom: ORTO_SWITCH_ZOOM, attribution: 'Ortokuva © Maanmittauslaitos', ...smoothTileOpts }
  );

  // =========================
  // LOKAALIT TILET (aina maasto + rinnevarjoste, ja ORTO z>=16)
  // =========================
  const maastoLocal = L.tileLayer('taustakartta_tiles/{z}/{x}/{y}.png', {
    tileSize: 256, minZoom: 13, maxZoom: 18, maxNativeZoom: 17,opacity: 1, tms: true, attribution: 'Maastokartta © Maanmittauslaitos', ...smoothTileOpts
  });

  const rinnevarjosteLocal = L.tileLayer('rinnevarjoste_tiles/{z}/{x}/{y}.png', {
    tileSize: 256, minZoom: 13, maxZoom: 18, maxNativeZoom: 17, opacity: 1, tms: true,  attribution: 'Rinnevarjoste © Maanmittauslaitos', ...smoothTileOpts
  });

  const ORTO_BOUNDS = L.latLngBounds(
    [60.5553, 26.8336], // SW
    [60.6447, 26.9505]  // NE
  );

  const ortoLocal = L.tileLayer('orto_tiles/{z}/{x}/{y}.jpg', {
    tileSize: 256,
    tms: true,
    opacity: 1,
    minNativeZoom: 17,
    maxNativeZoom: 17,
    minZoom: 13,
    maxZoom: 18,
    bounds: ORTO_BOUNDS,
    noWrap: true,
    attribution: 'Ortokuva © Maanmittauslaitos',
    ...smoothTileOpts
  });

  // =========================
  // POHJAKERROKSEN HALLINTA
  // =========================
  let activeBaseLayer = null;

  function desiredBaseLayer() {
    const base = document.querySelector('input[name="layer"]:checked').value;

    if (base === 'satelliitti') return null; // Esri näkyy taustalla
    if (base === 'maasto') return maastoLocal; // AINA lokaalisti
    if (base === 'rinnevarjoste') return rinnevarjosteLocal; // AINA lokaalisti
    if (base === 'mapant') return mapantLayer;
    
    if (base === 'orto') {
      return isOrtoLowZoom() ? mmlOrtoLow : ortoLocal; // VAIN orto vaihtaa zoomin mukaan
    }

    return null;
  }

  function setActiveBaseLayer(next) {
    if (activeBaseLayer === next) return;
    if (activeBaseLayer) map.removeLayer(activeBaseLayer);
    activeBaseLayer = next;
    if (activeBaseLayer) map.addLayer(activeBaseLayer);
  }

  function updateBaseLayers() {
    setActiveBaseLayer(desiredBaseLayer());
  }
  


  // =========================
  // OVERLAYT (ei välky)
  // =========================
  const overlaySelect = document.getElementById('overlaySelect');
  const overlayOnOffBtn = document.getElementById('overlayOnOffBtn');
  let overlayVisible = true;

  let overlayImg = null;
  let overlaySpec = null;

  function positionOverlayImg() {
    if (!overlayImg || !overlaySpec) return;

    const { lat, lon, widthKm, heightKm, angleDeg } = overlaySpec;
    const latlng = L.latLng(lat, lon);
    const center = map.latLngToLayerPoint(latlng);

    const kmToPx = (km) => {
      const p2 = map.latLngToLayerPoint(L.latLng(lat + (km / 111.32), lon));
      const p1 = map.latLngToLayerPoint(latlng);
      return Math.abs(p2.y - p1.y);
    };

    const widthPx = kmToPx(widthKm);
    const heightPx = kmToPx(heightKm);

    overlayImg.style.width = `${widthPx}px`;
    overlayImg.style.height = `${heightPx}px`;
    overlayImg.style.left = `${center.x - widthPx / 2}px`;
    overlayImg.style.top = `${center.y - heightPx / 2}px`;
    overlayImg.style.transform = `rotate(${angleDeg}deg)`;
  }

  function removeOverlayImg() {
    if (overlayImg && overlayImg.parentNode) overlayImg.parentNode.removeChild(overlayImg);
    overlayImg = null;
    overlaySpec = null;
  }

  function showOverlay(spec) {
    overlaySpec = spec;

    if (!overlayVisible || !overlaySpec) {
      removeOverlayImg();
      return;
    }

    if (!overlayImg) {
      overlayImg = document.createElement('img');
      overlayImg.style.position = 'absolute';
      overlayImg.style.opacity = '1.0';
      overlayImg.style.pointerEvents = 'none';
      overlayImg.style.zIndex = '999';
      overlayImg.style.transformOrigin = 'center center';
      overlayImg.style.mixBlendMode = 'normal';
      map.getPanes().overlayPane.appendChild(overlayImg);
    }

    if (overlayImg.src !== spec.src) overlayImg.src = spec.src;
    positionOverlayImg();
  }

  function applyOverlayFromSelect() {
    const v = overlaySelect.value;
    if (!overlayVisible || !v) {
      removeOverlayImg();
      return;
    }

    const specs = {
      esijukola:   { src:'EsiJukola.jpg', lat:60.56836, lon:26.92413, widthKm:3.48,  heightKm:3.015, angleDeg:11.2 },
      efky1:       { src:'EFKY_1.jpg',    lat:60.57791, lon:26.8854,  widthKm:2.1,  heightKm:2.92,  angleDeg:7.7 },
      efky2:       { src:'EFKY_2.jpg',    lat:60.58621, lon:26.87701, widthKm:2.83,  heightKm:4.04,  angleDeg:7.5 },
      pahavuori:   { src:'Pahavuori.jpg', lat:60.59109, lon:26.87734, widthKm:2.075,  heightKm:2.91,  angleDeg:7.9 },
      laukkakallio:   { src:'Laukkakallio.jpg', lat:60.60651, lon:26.83344, widthKm:2.08,  heightKm:2.905,  angleDeg:10.8 },
      tavastila:   { src:'Tavastila.jpg', lat:60.57469, lon:26.93866, widthKm:2.00,  heightKm:2.93,  angleDeg:7.5 },
      peippola:    { src:'Peippola.jpg',  lat:60.56241, lon:26.91001, widthKm:2.07,  heightKm:2.97,  angleDeg:7.6 },
      kirkkovuoret:{ src:'Kirkkovuoret.jpg', lat:60.60961, lon:26.90241, widthKm:2.955, heightKm:2.09, angleDeg:9.0 },
      rapukallio:{ src:'Rapukallio.jpg', lat:60.59749, lon:26.93026, widthKm:2.26, heightKm:2.305, angleDeg:11.2 },
      kooste:      { src:'Kooste.jpg',    lat:60.58716, lon:26.88541, widthKm:8.305, heightKm:11.845, angleDeg:8.8 },
      saarijarvi:  { src:'Saarijarvi.jpg',lat:60.60056, lon:26.89086, widthKm:8.48,  heightKm:6.03,  angleDeg:5.1 },
      1986:        { src:'EFKY_3.jpg',    lat:60.55766, lon:26.90186, widthKm:6.49,  heightKm:9.18,  angleDeg:5.1 },
      1975:        { src:'EFKY_4.jpg',    lat:60.59136, lon:26.90596, widthKm:5.215,  heightKm:7.39,  angleDeg:5.4 },
      rasteja:     { src:'Kooste_kuvitteellisilla_rasteilla.jpg', lat:60.58716, lon:26.88541, widthKm:8.305, heightKm:11.84, angleDeg:8.8 }
    };

    showOverlay(specs[v] || null);
  }

  // =========================
  // Punainen reitti
  // =========================
  const punainenReitti = [
    [60.5578, 26.8920],
    [60.5698, 26.8712],
    [60.5949, 26.8520],
    [60.5984, 26.8421],
    [60.6013, 26.8500],
    [60.6286, 26.8584],
    [60.6296, 26.8938],
    [60.6205, 26.8990],
    [60.6124, 26.9216],
    [60.6095, 26.9273],
    [60.6053, 26.9261],
    [60.6006, 26.9293],
    [60.5992, 26.9120],
    [60.5951, 26.9102],
    [60.5910, 26.9229],
    [60.5867, 26.9227],
    [60.5811, 26.9297],
    [60.5771, 26.9297],
    [60.5692, 26.8994],
    [60.5670, 26.8987],
    [60.5629, 26.9017],
    [60.5603, 26.9003],
    [60.5578, 26.8920]
  ];

  L.polyline(punainenReitti, {
    color: 'red',
    weight: 15,
    opacity: 0.3,
    lineCap: 'round',
    lineJoin: 'round',
    pane: 'topLinePane'
  }).addTo(map);

  // =========================
  // UI-eventit
  // =========================
  function updateAll() {
    updateBaseLayers();
    applyOverlayFromSelect();
  }

  document.querySelectorAll('input[name="layer"]').forEach(el => {
    el.addEventListener('change', updateAll);
  });

  overlaySelect.addEventListener('change', applyOverlayFromSelect);

  overlayOnOffBtn.addEventListener('click', () => {
    overlayVisible = !overlayVisible;
    overlayOnOffBtn.classList.toggle('off', !overlayVisible);
    overlaySelect.disabled = !overlayVisible;

    if (!overlayVisible) removeOverlayImg();
    else applyOverlayFromSelect();
  });

  map.on('zoomend', () => {
    updateBaseLayers();    
    positionOverlayImg();
  });

  map.on('move', () => {
    positionOverlayImg();
  });

  function setupCollapse(boxId, btnId) {
    const box = document.getElementById(boxId);
    const btn = document.getElementById(btnId);
    let collapsed = false;
    btn.addEventListener('click', () => {
      collapsed = !collapsed;
      box.classList.toggle('collapsed', collapsed);
      btn.textContent = collapsed ? '▼' : '▲';
    });
  }
  setupCollapse('layerToggle', 'collapseBtn1');
  setupCollapse('overlayToggle', 'collapseBtn2');

  // =========================
  // ☰ Lisää-modal (avaa/sulje)
  // =========================
  const moreBtn = document.getElementById('moreBtn');
  const moreModal = document.getElementById('moreModal');
  const moreCloseBtn = document.getElementById('moreCloseBtn');

  function openMore() {
    moreModal.classList.add('open');
    moreModal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
  }

  function closeMore() {
    moreModal.classList.remove('open');
    moreModal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }

  moreBtn.addEventListener('click', openMore);
  moreCloseBtn.addEventListener('click', closeMore);

  // Klikkaus taustaan sulkee (mutta ei kortin sisään)
  moreModal.addEventListener('click', (e) => {
    if (e.target === moreModal) closeMore();
  });

  // ESC sulkee
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && moreModal.classList.contains('open')) closeMore();
  });

  // Käynnistys
  updateAll();
</script>

</body>
</html>
